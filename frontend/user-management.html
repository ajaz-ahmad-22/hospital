<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Panel - User Management</title>
<link rel="stylesheet" href="styles.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  
    padding: 20px;
  }

  h1 {
    text-align: center;
    margin-bottom: 25px;
    color: #222;
  }
  
  .form-box {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 25px;
  }

  .form-box h3 {
    margin-bottom: 15px;
    color: #333;
  }

  .form-box input,
  .form-box select {
    padding: 8px;
    margin: 5px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }

  .form-box button {
    padding: 8px 14px;
    border: none;
    background-color: #16A249;
    color: white;
    border-radius: 5px;
    cursor: pointer;
    display: block;
    margin: 0 auto;
    width: 50%;
  }

  .form-box button:hover {
    background-color: #0056b3;
  }

  #usersTable {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  } 

  #usersTable th, #usersTable td {
    border: 1px solid #100f0f;
    padding: 10px;
  }

  #usersTable th {
    background-color: #16A249;
    color: white;
    text-align: center;
  }

  #usersTable td {
    text-align: center;
  }

  #usersTable td a {
    color: #007bff;
    cursor: pointer;
    text-decoration: none;
    font-weight: 500;
  }

  #usersTable td a:hover {
    text-decoration: underline;
    color: #0056b3;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin-top: 15px;
  }

  #logoutBtn {
    display: block;
    margin: 20px auto;
    background: #dc3545;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
  }

  #logoutBtn:hover {
    background: #b02a37;
  }

  /* Modal */
  .modal {
  display: none;
  position: fixed;
  z-index: 1000;
  padding-top: 60px;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow-y: auto;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
  background-color: #fff;
  margin: auto;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 800px;
  box-sizing: border-box;
}

.close {
  color: #aaa;
  float: right;
  font-size: 26px;
  font-weight: bold;
  cursor: pointer;
}

.close:hover {
  color: #000;
}

/* Media Query for small screens (Mobile) */
@media screen and (max-width: 600px) {
  .modal-content {
    width: 75%;
    padding: 15px;
    margin: 12%;
  }

  .close {
    font-size: 22px;
  }
}

  .export-buttons {
    margin-bottom: 15px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
  }

  .export-buttons input[type="date"] {
    padding: 5px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }

  .export-buttons button {
    background-color: #16A249;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 5px;
  }

  .export-buttons button:hover {
    background-color: #0056b3;
  }

  .user-divider {
    border: 0;
    border-top: 2px solid #e9ecef;
  }
</style>
</head>
<body>
  <div class="header">
  <img src="./10percent.png" alt="logi" class="logo">
  <div class="titles">
    <h2>Mohammadia Nursing Home</h2>
    <h2>Attendance Management System (AMS) 1.0</h2>
    <h1>Admin Panel - Users</h1>
  </div>
</div>

<div class="form-box">
  <h3>Add User</h3>
  <form id="addUserForm">
    <input type="text" id="name" placeholder="Full Name" required />
    <input type="text" id="staff_id" placeholder="Staff ID" required />
    <input type="password" id="password" placeholder="Password" required />
    <select id="role">
      <option value="Staff">Staff</option>
      <option value="Admin">Admin</option>
    </select>
    <button type="submit">Add Staff Member</button>
  </form>
</div>

<!-- Global Attendance Export -->
<div class="export-buttons" style="margin-bottom:20px;">
  <label>From: <input type="date" id="globalStartDate" /></label>
  <label>To: <input type="date" id="globalEndDate" /></label>
  <button id="exportAllExcel">Export All to Excel</button>
  <button id="exportAllPDF">Export All to PDF</button>
</div>

<h3>Existing Users</h3>

<div class="pagination">
  <div id="inactiveWarning" style="color:red; font-weight:bold; margin-right:10px;"></div>
  <input type="text" id="searchBar" placeholder="Search by Name or Staff ID" />
  <label for="usersPerPage">Users per page:</label>
  <select id="usersPerPage">
    <option value="10">10</option>
    <option value="20" selected>20</option>
    <option value="50">50</option>
    <option value="100">100</option>
  </select>
</div>

<table id="usersTable">
  <thead>
    <tr>
      <th>S. No.</th>
      <th>Name</th>
      <th>Staff ID</th>
      <th>Role</th>
      <th>Status</th>
      <th>Last Check In</th>
      <th>Last Check Out</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="pagination">
  <button id="prevPage">Previous</button>
  <span id="pageInfo"></span>
  <button id="nextPage">Next</button>
</div>

<button id="logoutBtn">Logout</button>

<!-- Attendance History Modal -->
<div id="attendanceModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Attendance History - <span id="modalName"></span></h3>

    <div class="export-buttons">
      <label>From: <input type="date" id="startDate" /></label>
      <label>To: <input type="date" id="endDate" /></label>
      <button id="filterAttendance">Filter</button>
      <button id="exportAttendanceExcel">Export to Excel</button>
      <button id="exportAttendancePDF">Export to PDF</button>
    </div>

    <table class="table table-striped">
      <thead>
        <tr><th>Check In</th><th>Check Out</th><th>Total Hours</th></tr>
      </thead>
      <tbody id="attendanceBody"></tbody>
    </table>
  </div>
</div>

<!-- Excel & PDF Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const API_URL = "http://192.168.35.70:5000/api/users";
const ATTENDANCE_URL = "http://192.168.35.70:5000/api/attendance";
const token = localStorage.getItem("token");
if (!token) window.location.href="login.html";

let allUsers = [], filteredUsers = [];
let currentPage = 1, usersPerPage = 20;
let currentAttendanceData = [], currentFilteredAttendance = [];
let currentAttendanceUserName = "", currentAttendanceStaffId = "";

// Decode JWT to check admin
function parseJwt (token) {
  try {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    return JSON.parse(window.atob(base64));
  } catch { return null; }
}
const decoded = parseJwt(token);
const loggedInRole = decoded?.role || "";

// Load users
async function loadUsers() {
  const res = await fetch(API_URL, { headers: { "Authorization": "Bearer "+token } });
  allUsers = await res.json();
  if (loggedInRole === "Admin") allUsers = allUsers.filter(u => u.role !== "Admin");
  filteredUsers = allUsers;
  renderTable();
}

// Render users with line between
function renderTable() {
  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML = "";
  const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
  const start = (currentPage - 1) * usersPerPage;
  const pageUsers = filteredUsers.slice(start, start + usersPerPage);

  let inactiveCount = 0;
  const today = new Date();

  pageUsers.forEach((u, i) => {
    const tr = document.createElement("tr");
    const serial = start + i + 1;

    // Inactivity check
    const lastCheckIn = u.last_check_in ? new Date(u.last_check_in) : null;
    const lastCheckOut = u.last_check_out ? new Date(u.last_check_out) : null;
    let inactive = false;
    const lastActivity = lastCheckIn || lastCheckOut;
    if (!lastActivity) inactive = true;
    else {
      const diffDays = Math.floor((today - lastActivity) / (1000 * 60 * 60 * 24));
      if (diffDays >= 10) inactive = true;
    }
    if (inactive) inactiveCount++;

    const actionButtons = u.role === "Admin" ? "" :
      `<button onclick="toggleStatus('${u.staff_id}','${u.status}')">${u.status==='Active'?'Disable':'Enable'}</button>
       <button onclick="deleteUser('${u.staff_id}')">Delete</button>`;

    tr.innerHTML = `
      <td>${serial}</td>
      <td><a onclick="showAttendance('${u.staff_id}','${u.name}')" style="color:${inactive?'red':'#007bff'}">
        ${u.name}${inactive?' ❗':''}</a></td>
      <td>${u.staff_id}</td>
      <td>${u.role}</td>
      <td>${u.status}</td>
      <td>${u.last_check_in ? new Date(u.last_check_in).toLocaleString():"-"}</td>
      <td>${u.last_check_out ? new Date(u.last_check_out).toLocaleString():"-"}</td>
      <td>${actionButtons}</td>`;

    tbody.appendChild(tr);

    const hr = document.createElement("tr");
    hr.innerHTML = `<td colspan="8"><hr class="user-divider" /></td>`;
    tbody.appendChild(hr);
  });

  document.getElementById("pageInfo").textContent = `Page ${currentPage} of ${totalPages || 1}`;

  const warningDiv = document.getElementById("inactiveWarning");
  if (inactiveCount > 0) warningDiv.innerText = `⚠️ ${inactiveCount} user(s) inactive for 10+ days`;
  else warningDiv.innerText = "";
}

// ------------------- Global Export All Users Attendance -------------------
document.getElementById("exportAllExcel").onclick = async () => {
  const start = document.getElementById("globalStartDate").value;
  const end = document.getElementById("globalEndDate").value;
  if (!start || !end) return alert("Select both start and end dates");

  const startDate = new Date(start);
  const endDate = new Date(end); endDate.setHours(23,59,59,999);

  const rows = [];

  for (let u of allUsers) {
    const res = await fetch(`${ATTENDANCE_URL}/history/${u.staff_id}`, { headers: { Authorization: "Bearer " + token } });
    const data = await res.json();

    const filtered = data.filter(a => a.check_in && new Date(a.check_in) >= startDate && new Date(a.check_in) <= endDate);
    let totalHours = 0;

    filtered.forEach(a => {
      if (a.check_in && a.check_out) {
        const diffMs = new Date(a.check_out) - new Date(a.check_in);
        totalHours += diffMs / 1000 / 60 / 60;
      }
    });

    rows.push({
      Name: u.name,
      "Staff ID": u.staff_id,
      "Total Hours": totalHours.toFixed(2)
    });
  }

  const ws = XLSX.utils.json_to_sheet(rows);
  ws['!cols'] = [
    { wch: 25 }, 
    { wch: 20 }, 
    { wch: 15 }  
  ];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "All Attendance");
  XLSX.writeFile(wb, `All_Users_Attendance.xlsx`);
};

document.getElementById("exportAllPDF").onclick = async () => {
  const start = document.getElementById("globalStartDate").value;
  const end = document.getElementById("globalEndDate").value;
  if (!start || !end) return alert("Select both start and end dates");

  const startDate = new Date(start);
  const endDate = new Date(end); endDate.setHours(23,59,59,999);

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });
  let y = 40;

  doc.setFontSize(14);
  doc.text(`All Users Attendance Report`, 40, y); y += 25;
  doc.setFontSize(12);
  doc.text(`From: ${startDate.toLocaleDateString()} To: ${endDate.toLocaleDateString()}`, 40, y); y += 20;

  doc.text("Name", 40, y);
  doc.text("Staff ID", 250, y);
  doc.text("Total Hours", 400, y);
  y += 8;
  doc.setLineWidth(0.5);
  doc.line(40, y, 550, y);
  y += 15;

  for (let u of allUsers) {
    const res = await fetch(`${ATTENDANCE_URL}/history/${u.staff_id}`, { headers: { Authorization: "Bearer " + token } });
    const data = await res.json();

    const filtered = data.filter(a => a.check_in && new Date(a.check_in) >= startDate && new Date(a.check_in) <= endDate);
    let totalHours = 0;
    filtered.forEach(a => {
      if (a.check_in && a.check_out) {
        const diffMs = new Date(a.check_out) - new Date(a.check_in);
        totalHours += diffMs / 1000 / 60 / 60;
      }
    });

    doc.text(u.name, 40, y);
    doc.text(u.staff_id, 250, y);
    doc.text(totalHours.toFixed(2), 400, y);
    y += 20;
    if (y > 750) { doc.addPage(); y = 40; }
  }

  doc.save(`All_Users_Attendance.pdf`);
};

// Search + pagination
document.getElementById("searchBar").addEventListener("input", e=>{
  const term = e.target.value.toLowerCase();
  filteredUsers = allUsers.filter(u =>
    u.name.toLowerCase().includes(term) || u.staff_id.toLowerCase().includes(term)
  );
  currentPage = 1; renderTable();
});
document.getElementById("nextPage").onclick=()=>{if(currentPage*usersPerPage<filteredUsers.length){currentPage++;renderTable();}};
document.getElementById("prevPage").onclick=()=>{if(currentPage>1){currentPage--;renderTable();}};
document.getElementById("usersPerPage").onchange=e=>{usersPerPage=parseInt(e.target.value);currentPage=1;renderTable();};

// Add User
document.getElementById("addUserForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const name=document.getElementById("name").value;
  const staff_id=document.getElementById("staff_id").value;
  const password=document.getElementById("password").value;
  const role=document.getElementById("role").value;
  const res=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},body:JSON.stringify({name,staff_id,password,role})});
  const data=await res.json();
  if(res.ok){alert(data.message);loadUsers();e.target.reset();} else alert(data.error);
});

// Status toggle & delete
async function toggleStatus(staff_id,currentStatus){
  const newStatus=currentStatus==='Active'?'Inactive':'Active';
  await fetch(`${API_URL}/status/${staff_id}`,{method:"PUT",headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},body:JSON.stringify({status:newStatus})});
  loadUsers();
}
async function deleteUser(staff_id){
  if(!confirm("Delete this user?"))return;
  const res=await fetch(`${API_URL}/${staff_id}`,{method:"DELETE",headers:{Authorization:"Bearer "+token}});
  if(res.ok)loadUsers();
}

// Logout
document.getElementById("logoutBtn").onclick=()=>{localStorage.removeItem("token");window.location.href="login.html";};

// Modal logic + filter/export
const modal=document.getElementById("attendanceModal"),span=document.getElementsByClassName("close")[0];
span.onclick=()=>modal.style.display="none";
window.onclick=e=>{if(e.target==modal)modal.style.display="none";};

// ------------------- Attendance + Export -------------------
async function showAttendance(staff_id, name) {
  document.getElementById("modalName").innerText = name;
  currentAttendanceUserName = name;
  currentAttendanceStaffId = staff_id;

  const res = await fetch(`${ATTENDANCE_URL}/history/${staff_id}`, { headers: { Authorization: "Bearer " + token } });
  const data = await res.json();
  currentAttendanceData = data;
  currentFilteredAttendance = [];

  const tbody = document.getElementById("attendanceBody");
  tbody.innerHTML = "";

  const today = new Date();
  let lastCheckInDate = null;

  data.forEach(a => {
    const checkIn = a.check_in ? new Date(a.check_in) : null;
    const checkOut = a.check_out ? new Date(a.check_out) : null;
    if (checkIn) lastCheckInDate = checkIn;

    let totalHours = "-";
    if (checkIn && checkOut) {
      const diffMs = checkOut - checkIn;
      const hours = Math.floor(diffMs / 1000 / 60 / 60);
      const minutes = Math.floor((diffMs / 1000 / 60) % 60);
      totalHours = `${hours}h ${minutes}m`;
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${checkIn ? checkIn.toLocaleString() : "-"}</td>
                    <td>${checkOut ? checkOut.toLocaleString() : "-"}</td>
                    <td>${totalHours}</td>`;
    tbody.appendChild(tr);
  });

  if (lastCheckInDate) {
    const diffDays = Math.floor((today - lastCheckInDate) / (1000 * 60 * 60 * 24));
    if (diffDays >= 10) alert(`⚠️ Warning: This user has no activity for ${diffDays} days!`);
  }

  modal.style.display = "block";
}

// Filter attendance
document.getElementById("filterAttendance").onclick=()=>{
  const s=document.getElementById("startDate").value,e=document.getElementById("endDate").value;
  if(!s||!e)return alert("Select both dates");
  const start=new Date(s),end=new Date(e); end.setHours(23,59,59,999);
  const f=currentAttendanceData.filter(a=>a.check_in && new Date(a.check_in)>=start && new Date(a.check_in)<=end);
  const tbody=document.getElementById("attendanceBody");
  tbody.innerHTML="";
  f.forEach(a=>{
    const checkIn = a.check_in ? new Date(a.check_in) : "-";
    const checkOut = a.check_out ? new Date(a.check_out) : "-";
    let totalHours = "-";
    if(checkIn !== "-" && checkOut !== "-"){
      const diffMs = checkOut - checkIn;
      const hours = Math.floor(diffMs / 1000 / 60 / 60);
      const minutes = Math.floor((diffMs / 1000 / 60) % 60);
      totalHours = `${hours}h ${minutes}m`;
    }
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${checkIn!=="-"?checkIn.toLocaleString():"-"}</td>
                  <td>${checkOut!=="-"?checkOut.toLocaleString():"-"}</td>
                  <td>${totalHours}</td>`;
    tbody.appendChild(tr);
  });
  currentFilteredAttendance=f; if(!f.length)alert("No records found.");
};

// ------------------- Export Excel -------------------
document.getElementById("exportAttendanceExcel").onclick = () => {
  const data = currentFilteredAttendance.length ? currentFilteredAttendance : currentAttendanceData;
  if (!data.length) return alert("No attendance records.");

  const rows = data.map(a => {
    const checkIn = a.check_in ? new Date(a.check_in).toLocaleString() : "";
    const checkOut = a.check_out ? new Date(a.check_out).toLocaleString() : "";
    let totalHours = 0;
    if (checkIn && checkOut) totalHours = (new Date(a.check_out)-new Date(a.check_in))/1000/60/60;
    return {
      Name: currentAttendanceUserName,
      "Check In": checkIn,
      "Check Out": checkOut,
      "Total Hours": totalHours.toFixed(2)
    };
  });

  const totalHoursSum = rows.reduce((sum, r) => sum + parseFloat(r["Total Hours"]), 0);
  rows.push({ Name: "Monthly Total", "Check In": "", "Check Out": "", "Total Hours": totalHoursSum.toFixed(2) });

  const ws = XLSX.utils.json_to_sheet(rows, { skipHeader: false });
  ws['!cols'] = [{wch:25},{wch:25},{wch:25},{wch:15}];

  const headerCells = ["A1","B1","C1","D1"];
  headerCells.forEach(cell => {
    if(ws[cell]) ws[cell].s = { font:{bold:true,color:{rgb:"FFFFFF"}}, fill:{fgColor:{rgb:"16A249"}}, alignment:{horizontal:"center"}, border:{top:{style:"thin",color:{rgb:"000000"}},bottom:{style:"thin",color:{rgb:"000000"}},left:{style:"thin",color:{rgb:"000000"}},right:{style:"thin",color:{rgb:"000000"}}} };
  });

  const range = XLSX.utils.decode_range(ws['!ref']);
  for(let R=range.s.r;R<=range.e.r;R++){
    for(let C=range.s.c;C<=range.e.c;C++){
      const cellRef=XLSX.utils.encode_cell({c:C,r:R});
      if(ws[cellRef]){
        ws[cellRef].t='s';
        ws[cellRef].s=ws[cellRef].s||{};
        ws[cellRef].s.fill=ws[cellRef].s.fill||{};
        if(R>0) ws[cellRef].s.fill.fgColor={rgb:R%2===0?"F2F2F2":"FFFFFF"};
        ws[cellRef].s.border={top:{style:"thin",color:{rgb:"000000"}},bottom:{style:"thin",color:{rgb:"000000"}},left:{style:"thin",color:{rgb:"000000"}},right:{style:"thin",color:{rgb:"000000"}}};
        ws[cellRef].s.alignment={horizontal:"center"};
      }
    }
  }

  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Attendance");
  XLSX.writeFile(wb, `${currentAttendanceUserName}_attendance.xlsx`);
};

// ------------------- Export PDF -------------------
document.getElementById("exportAttendancePDF").onclick = () => {
  const data = currentFilteredAttendance.length ? currentFilteredAttendance : currentAttendanceData;
  if (!data.length) return alert("No attendance records.");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:"portrait", unit:"pt", format:"a4" });
  let y = 40;

  doc.setFontSize(14); doc.text(`Name: ${currentAttendanceUserName}`,40,y); y+=20;
  doc.text(`Staff ID: ${currentAttendanceStaffId}`,40,y); y+=20;

  doc.setFontSize(12);
  doc.text("Check In",40,y); doc.text("Check Out",200,y); doc.text("Total Hours",360,y); y+=8;
  doc.setLineWidth(0.5); doc.line(40,y,550,y); y+=15;

  let totalHoursSum=0;
  data.forEach(a=>{
    const checkIn=a.check_in?new Date(a.check_in):"-";
    const checkOut=a.check_out?new Date(a.check_out):"-";
    let totalHours=0;
    if(checkIn!=="-"&&checkOut!=="-"){ totalHours=(checkOut-checkIn)/1000/60/60; totalHoursSum+=totalHours; }
    doc.text(checkIn!=="-"?checkIn.toLocaleString():"-",40,y);
    doc.text(checkOut!=="-"?checkOut.toLocaleString():"-",200,y);
    doc.text(totalHours.toFixed(2),360,y); y+=20;
    if(y>750){ doc.addPage(); y=40; }
  });

  doc.text("Monthly Total",40,y); doc.text("",200,y); doc.text(totalHoursSum.toFixed(2),360,y);
  doc.save(`${currentAttendanceUserName}_attendance.pdf`);
};

// Initialize
loadUsers();
</script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
</body>
</html>

